{% extends 'base.html' %}
{% load static %}

{% block title %}Returns - Smart Supply{% endblock %}
{% block page_title %}Returns Management{% endblock %}

{% block content %}
<div class="space-y-6 animate-fadeIn">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h2 class="text-3xl font-bold tracking-tight text-white">Returns Management</h2>
            <p class="text-slate-400 mt-1">Track borrowed items and process returns</p>
        </div>
        
        <a href="{% url 'qr_scanner' %}" up-target="main" up-follow class="inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm rounded-lg font-medium transition-all duration-200 cursor-pointer bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white shadow-lg shadow-green-500/20">
            <i data-lucide="qr-code" class="w-5 h-5"></i>
            Scan to Return
        </a>
    </div>
    
    <!-- Filters -->
    <div class="flex flex-wrap gap-2">
        <a href="{% url 'returns' %}" up-target="main" up-follow
           class="{% if current_filter == 'all' or not current_filter %}bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white shadow-lg shadow-green-500/20{% else %}bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10{% endif %} inline-flex items-center justify-center gap-2 px-3 py-1.5 text-xs rounded-lg font-medium transition-all duration-200 cursor-pointer">
            All Active
        </a>
        <a href="{% url 'returns' %}?filter=overdue" up-target="main" up-follow
           class="{% if current_filter == 'overdue' %}bg-red-500/10 text-red-400 border border-red-500/30{% else %}bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10{% endif %} inline-flex items-center justify-center gap-2 px-3 py-1.5 text-xs rounded-lg font-medium transition-all duration-200 cursor-pointer">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            Overdue
        </a>
        <a href="{% url 'returns' %}?filter=due_soon" up-target="main" up-follow
           class="{% if current_filter == 'due_soon' %}bg-amber-500/10 text-amber-400 border border-amber-500/30{% else %}bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10{% endif %} inline-flex items-center justify-center gap-2 px-3 py-1.5 text-xs rounded-lg font-medium transition-all duration-200 cursor-pointer">
            <i data-lucide="clock" class="w-4 h-4"></i>
            Due Soon
        </a>
        <a href="{% url 'returns' %}?filter=history" up-target="main" up-follow
           class="{% if current_filter == 'history' %}bg-blue-600/20 text-blue-400 border border-blue-500/30{% else %}bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10{% endif %} inline-flex items-center justify-center gap-2 px-3 py-1.5 text-xs rounded-lg font-medium transition-all duration-200 cursor-pointer ml-auto">
            <i data-lucide="history" class="w-4 h-4"></i>
            Return History
        </a>
    </div>
    
    <!-- Items List -->
    {% if current_filter == 'history' %}
    <div class="space-y-8">
        {% for condition, items in categorized.items %}
        {% if items %}
        <div class="space-y-4">
            <h3 class="text-sm font-bold uppercase tracking-widest flex items-center gap-2
                {% if condition == 'good' %}text-green-400
                {% elif condition == 'damaged' %}text-amber-400
                {% elif condition == 'lost' %}text-red-400{% endif %}">
                {% if condition == 'good' %}<i data-lucide="check-circle" class="w-4 h-4"></i>
                {% elif condition == 'damaged' %}<i data-lucide="alert-triangle" class="w-4 h-4"></i>
                {% elif condition == 'lost' %}<i data-lucide="x-circle" class="w-4 h-4"></i>{% endif %}
                {{ condition|title }} Condition
                <span class="ml-auto px-2 py-0.5 rounded-full bg-white/5 text-[10px] text-slate-500">{{ items.count }}</span>
            </h3>
            
            <div class="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="border-b border-white/10 bg-white/[0.02]">
                        <tr>
                            <th class="px-6 py-4 text-left font-semibold text-slate-300">Equipment</th>
                            <th class="px-6 py-4 text-left font-semibold text-slate-300">Borrower</th>
                            <th class="px-6 py-4 text-left font-semibold text-slate-300">Return Date</th>
                            <th class="px-6 py-4 text-left font-semibold text-slate-300">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {% for item in items %}
                        <tr class="hover:bg-white/[0.01] transition-colors">
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center">
                                        <i data-lucide="monitor" class="w-4 h-4 text-slate-500"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-white">{{ item.equipment_instance.instance_code }}</p>
                                        <p class="text-[10px] text-slate-500 uppercase">{{ item.equipment_instance.supply.name }}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <p class="text-white">{{ item.borrower.get_full_name }}</p>
                            </td>
                            <td class="px-6 py-4 text-slate-400">
                                {{ item.returned_at|date:"M d, Y H:i" }}
                            </td>
                            <td class="px-6 py-4">
                                <p class="text-xs text-slate-500 italic">{{ item.return_notes|default:"No notes provided" }}</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
        
        {% if not returned_items %}
        <div class="bg-white/5 border border-white/10 rounded-2xl p-12 text-center">
            <i data-lucide="history" class="w-12 h-12 text-slate-700 mx-auto mb-4"></i>
            <p class="text-slate-400">No return history available yet.</p>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="bg-white/5 border border-white/10 rounded-2xl overflow-hidden">
        <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="border-b border-white/10 bg-white/[0.02]">
                <tr>
                    <th class="px-6 py-4 text-left font-semibold text-slate-300">Equipment</th>
                    <th class="px-6 py-4 text-left font-semibold text-slate-300">Borrower</th>
                    <th class="px-6 py-4 text-left font-semibold text-slate-300">Borrowed</th>
                    <th class="px-6 py-4 text-left font-semibold text-slate-300">Due Date</th>
                    <th class="px-6 py-4 text-left font-semibold text-slate-300">Status</th>
                    <th class="px-6 py-4 text-left font-semibold text-slate-300">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-white/5">
                {% for item in borrowed_items %}
                <tr class="{% if item.is_overdue %}bg-red-500/5{% endif %} hover:bg-white/[0.03] transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-slate-700 flex items-center justify-center">
                                <i data-lucide="monitor" class="w-5 h-5 text-slate-400"></i>
                            </div>
                            <div>
                                <p class="font-medium text-white">{{ item.equipment_instance.instance_code }}</p>
                                <p class="text-sm text-slate-400">{{ item.equipment_instance.supply.name }}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div>
                            <p class="font-medium text-white">{{ item.borrower.get_full_name }}</p>
                            <p class="text-sm text-slate-400">{{ item.borrower.department.name }}</p>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-slate-400">
                        {{ item.borrowed_at|date:"M d, Y" }}
                    </td>
                    <td class="px-6 py-4">
                        <span class="{% if item.is_overdue %}text-red-400 font-medium{% else %}text-slate-300{% endif %}">
                            {{ item.return_deadline|date:"M d, Y" }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        {% if item.is_overdue %}
                        <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-semibold bg-red-500/10 text-red-400 border border-red-500/30 animate-pulse">{{ item.overdue_days }} days overdue</span>
                        {% elif item.days_until_due <= 1 %}
                        <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-semibold bg-amber-500/10 text-amber-400 border border-amber-500/30">Due today</span>
                        {% else %}
                        <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-semibold bg-blue-500/10 text-blue-400 border border-blue-500/30">{{ item.days_until_due }} days left</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2"
                             x-data="{ showReturn: false, status: 'good', notes: '' }">
                            <button @click="showReturn = true" class="inline-flex items-center justify-center gap-2 px-3 py-1.5 text-xs rounded-lg font-medium transition-all duration-200 cursor-pointer bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white shadow-lg shadow-green-500/20">
                                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                Return
                            </button>
                            
                            <!-- Return Modal -->
                            <template x-if="showReturn">
                                <div class="fixed inset-0 bg-slate-950/40 backdrop-blur-xl z-[60] flex items-center justify-center p-4"
                                     @click.self="showReturn = false"
                                     x-transition:enter="transition ease-out duration-300"
                                     x-transition:enter-start="opacity-0"
                                     x-transition:enter-end="opacity-100">
                                    <div class="bg-slate-900/90 border border-white/10 rounded-2xl shadow-2xl max-w-md w-full overflow-hidden animate-fadeIn" 
                                         @click.stop
                                         x-transition:enter="transition ease-out duration-300 transform scale-95"
                                         x-transition:enter-start="opacity-0 scale-95"
                                         x-transition:enter-end="opacity-100 scale-100">
                                        
                                        <!-- Modal Header -->
                                        <div class="px-8 py-6 border-b border-white/10 flex justify-between items-center bg-gradient-to-r from-green-500/10 to-transparent">
                                            <div>
                                                <h3 class="text-xl font-bold text-white">Process Return</h3>
                                                <p class="text-xs text-slate-500 mt-0.5 uppercase tracking-widest font-bold">Equipment Certification</p>
                                            </div>
                                            <button @click="showReturn = false" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/10 text-slate-400 hover:text-white transition-all">
                                                <i data-lucide="x" class="w-5 h-5"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Equipment Info -->
                                        <div class="px-8 py-5 bg-white/5 border-b border-white/5">
                                            <div class="flex items-center gap-4">
                                                <div class="w-12 h-12 rounded-xl bg-slate-800 border border-white/10 flex items-center justify-center shadow-inner">
                                                    <i data-lucide="monitor" class="w-6 h-6 text-slate-500"></i>
                                                </div>
                                                <div>
                                                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Selected Item</p>
                                                    <p class="font-bold text-white">{{ item.equipment_instance.instance_code }}</p>
                                                    <p class="text-xs text-slate-400 font-medium">{{ item.equipment_instance.supply.name }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <form hx-post="{% url 'process_return' %}"
                                              hx-target="closest tr"
                                              hx-swap="outerHTML"
                                              @htmx:after-request="showReturn = false">
                                            {% csrf_token %}
                                            <input type="hidden" name="borrowed_item_id" value="{{ item.id }}">
                                            
                                            <div class="p-8 space-y-6">
                                                <div>
                                                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-4">Functional Status</label>
                                                    <div class="grid grid-cols-3 gap-3">
                                                        <!-- Good Condition -->
                                                        <button type="button" @click="status = 'good'"
                                                                class="flex flex-col items-center justify-center py-4 rounded-xl font-bold transition-all duration-300 border-2"
                                                                :class="status === 'good' ? 'bg-green-500/10 border-green-500/50 text-green-400 shadow-lg shadow-green-500/10' : 'bg-white/5 border-white/5 text-slate-500 hover:bg-white/10'">
                                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center mb-1.5 transition-all"
                                                                 :class="status === 'good' ? 'bg-green-500/20' : 'bg-slate-800'">
                                                                <i data-lucide="check-circle" class="w-5 h-5"></i>
                                                            </div>
                                                            <span class="text-[10px] uppercase tracking-wider">Good</span>
                                                        </button>
                                                        <!-- Damaged Condition -->
                                                        <button type="button" @click="status = 'damaged'"
                                                                class="flex flex-col items-center justify-center py-4 rounded-xl font-bold transition-all duration-300 border-2"
                                                                :class="status === 'damaged' ? 'bg-amber-500/10 border-amber-500/50 text-amber-400 shadow-lg shadow-amber-500/10' : 'bg-white/5 border-white/5 text-slate-500 hover:bg-white/10'">
                                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center mb-1.5 transition-all"
                                                                 :class="status === 'damaged' ? 'bg-amber-500/20' : 'bg-slate-800'">
                                                                <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                                                            </div>
                                                            <span class="text-[10px] uppercase tracking-wider">Damaged</span>
                                                        </button>
                                                        <!-- Lost Condition -->
                                                        <button type="button" @click="status = 'lost'"
                                                                class="flex flex-col items-center justify-center py-4 rounded-xl font-bold transition-all duration-300 border-2"
                                                                :class="status === 'lost' ? 'bg-red-500/10 border-red-500/50 text-red-400 shadow-lg shadow-red-500/10' : 'bg-white/5 border-white/5 text-slate-500 hover:bg-white/10'">
                                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center mb-1.5 transition-all"
                                                                 :class="status === 'lost' ? 'bg-red-500/20' : 'bg-slate-800'">
                                                                <i data-lucide="x-circle" class="w-5 h-5"></i>
                                                            </div>
                                                            <span class="text-[10px] uppercase tracking-wider">Lost</span>
                                                        </button>
                                                    </div>
                                                    <input type="hidden" name="return_status" :value="status">
                                                </div>
                                                
                                                <div x-show="status !== 'good'" x-collapse>
                                                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Diagnostic Notes</label>
                                                    <textarea x-model="notes" name="notes" 
                                                              class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:outline-none focus:ring-2 focus:ring-green-500/20 focus:border-green-500/50 transition-all resize-none italic text-sm" 
                                                              placeholder="Provide detailed incident report..." rows="3"></textarea>
                                                </div>
                                            </div>
                                            
                                            <div class="p-8 pt-0 flex gap-4">
                                                <button type="button" @click="showReturn = false" 
                                                        class="flex-1 px-4 py-3.5 bg-white/5 border border-white/10 rounded-xl font-bold text-slate-500 hover:bg-white/10 transition-all">
                                                    Aboundon
                                                </button>
                                                <button type="submit" 
                                                        class="flex-2 px-8 py-3.5 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white rounded-xl font-bold transition-all duration-300 shadow-lg shadow-green-500/20 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                                        :disabled="status !== 'good' && !notes">
                                                    Process System Entry
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-12 px-6">
                        <i data-lucide="package-check" class="w-16 h-16 text-slate-600 mx-auto mb-4"></i>
                        <h3 class="text-lg font-semibold text-slate-300 mb-2">No items to return</h3>
                        <p class="text-slate-500">All borrowed items have been returned</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
