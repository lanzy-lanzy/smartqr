{% extends 'base.html' %}
{% load static %}

{% block title %}New Request - Smart Supply{% endblock %}
{% block page_title %}New Request{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto animate-fadeIn" 
     x-data="requestForm()" 
     x-init="init()">
    
    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold tracking-tight text-white">Create New Request</h2>
        <p class="text-slate-400 mt-1">Select items you need and submit your request for approval</p>
    </div>
    
    <form @submit.prevent="submitRequest" class="space-y-6">
        {% csrf_token %}
        
        <!-- Supply Selection -->
        <div class="bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Select Supply</h3>
            
            <!-- Search -->
            <div class="relative mb-4">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500"></i>
                <input type="text" 
                       x-model="searchQuery"
                       @input.debounce.300ms="searchSupplies"
                       class="w-full bg-white/5 border border-white/10 rounded-lg pl-12 pr-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500 transition-all" 
                       placeholder="Search for supplies...">
            </div>
            
            <!-- Category Filter -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button type="button" 
                        @click="filterCategory = ''"
                        :class="filterCategory === '' ? 'bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white shadow-lg shadow-green-500/20' : 'bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10'"
                        class="inline-flex items-center justify-center gap-2 px-3 py-1.5 text-xs rounded-lg font-medium transition-all duration-200 cursor-pointer">
                    All
                </button>
                {% for cat in categories %}
                <button type="button" 
                        @click="filterCategory = '{{ cat.id }}'; searchSupplies()"
                        :class="filterCategory === '{{ cat.id }}' ? 'bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white shadow-lg shadow-green-500/20' : 'bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10'"
                        class="inline-flex items-center justify-center gap-2 px-3 py-1.5 text-xs rounded-lg font-medium transition-all duration-200 cursor-pointer">
                    {{ cat.name }}
                </button>
                {% endfor %}
            </div>
            
            <!-- Results -->
            <div class="border border-white/10 rounded-xl max-h-64 overflow-y-auto">
                <template x-if="loading">
                    <div class="p-8 text-center">
                        <div class="w-4 h-4 border-2 border-slate-600 border-t-slate-300 rounded-full animate-spin mx-auto mb-2"></div>
                        <p class="text-sm text-slate-500">Searching...</p>
                    </div>
                </template>
                
                <template x-if="!loading && searchResults.length === 0">
                    <div class="p-8 text-center">
                        <i data-lucide="package-search" class="w-12 h-12 text-slate-600 mx-auto mb-2"></i>
                        <p class="text-slate-500">No supplies found</p>
                    </div>
                </template>
                
                <template x-for="supply in searchResults" :key="supply.id">
                    <div @click="selectSupply(supply)"
                         :class="selectedSupply?.id === supply.id ? 'bg-green-500/20 border-l-4 border-l-green-500' : 'hover:bg-white/5'"
                         class="p-4 border-b border-white/5 last:border-b-0 cursor-pointer transition-colors">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-white" x-text="supply.name"></p>
                                <p class="text-sm text-slate-400" x-text="supply.category"></p>
                            </div>
                            <div class="text-right">
                                <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-semibold bg-green-500/10 text-green-400 border border-green-500/30" x-show="supply.available > 0">
                                    <span x-text="supply.available"></span> <span x-text="supply.unit"></span>
                                </span>
                                <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-semibold bg-red-500/10 text-red-400 border border-red-500/30" x-show="supply.available === 0">Out of Stock</span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Selected Supply Display -->
            <template x-if="selectedSupply">
                <div class="mt-4 p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                                <i data-lucide="check" class="w-5 h-5 text-green-400"></i>
                            </div>
                            <div>
                                <p class="font-medium text-green-300" x-text="selectedSupply.name"></p>
                                <p class="text-sm text-green-400/70" x-text="selectedSupply.category"></p>
                            </div>
                        </div>
                        <button type="button" @click="selectedSupply = null" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                            <i data-lucide="x" class="w-4 h-4 text-green-400"></i>
                        </button>
                    </div>
                </div>
            </template>
            
            <input type="hidden" name="supply_id" :value="selectedSupply?.id">
        </div>
        
        <!-- Specific Instance Selection (for equipment) -->
        <template x-if="selectedSupply && !selectedSupply.is_consumable">
            <div class="bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl p-6">
                <h3 class="text-lg font-semibold text-white mb-4">Select Specific Unit (Optional)</h3>
                <p class="text-sm text-slate-400 mb-4">You can request a specific equipment unit or let GSO assign one for you.</p>
                
                <div class="space-y-2 max-h-48 overflow-y-auto">
                    <div @click="selectedInstance = null"
                         :class="selectedInstance === null ? 'bg-green-500/20 border-green-500' : 'border-white/10 hover:bg-white/5'"
                         class="p-3 border rounded-xl cursor-pointer transition-colors">
                        <p class="font-medium text-white">Any Available Unit</p>
                        <p class="text-sm text-slate-400">Let GSO assign the best available unit</p>
                    </div>
                    
                    <template x-for="instance in availableInstances" :key="instance.id">
                        <div @click="selectedInstance = instance"
                             :class="selectedInstance?.id === instance.id ? 'bg-green-500/20 border-green-500' : 'border-white/10 hover:bg-white/5'"
                             class="p-3 border rounded-xl cursor-pointer transition-colors">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-white" x-text="instance.code"></p>
                                    <p class="text-sm text-slate-400" x-text="'S/N: ' + (instance.serial || 'N/A')"></p>
                                </div>
                                <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-semibold bg-green-500/10 text-green-400 border border-green-500/30">Available</span>
                            </div>
                        </div>
                    </template>
                </div>
                
                <input type="hidden" name="instance_id" :value="selectedInstance?.id">
            </div>
        </template>
        
        <!-- Request Details -->
        <div class="bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Request Details</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <!-- Quantity -->
                 <div>
                     <label class="block text-sm font-medium text-slate-300 mb-2">Quantity</label>
                     <div class="flex items-center gap-2">
                         <button type="button" 
                                 @click="quantity = Math.max(1, quantity - 1)"
                                 class="inline-flex items-center justify-center gap-2 px-3 py-1.5 text-xs rounded-lg font-medium transition-all duration-200 cursor-pointer bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10">
                             <i data-lucide="minus" class="w-4 h-4"></i>
                         </button>
                         <input type="number" 
                                x-model="quantity"
                                name="quantity" 
                                min="1" 
                                :max="selectedSupply?.available || 100"
                                class="w-20 bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500 transition-all text-center">
                         <button type="button" 
                                 @click="quantity = Math.min(selectedSupply?.available || 100, quantity + 1)"
                                 class="inline-flex items-center justify-center gap-2 px-3 py-1.5 text-xs rounded-lg font-medium transition-all duration-200 cursor-pointer bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10">
                             <i data-lucide="plus" class="w-4 h-4"></i>
                         </button>
                         <span class="text-sm text-slate-400" x-text="selectedSupply?.unit || 'pcs'"></span>
                     </div>
                 </div>
                 
                 <!-- Priority -->
                 <div>
                     <label class="block text-sm font-medium text-slate-300 mb-2">Priority</label>
                     <select name="priority" x-model="priority" class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500 transition-all">
                         {% for value, label in priority_choices %}
                         <option value="{{ value }}">{{ label }}</option>
                         {% endfor %}
                     </select>
                 </div>
             </div>
             
             <!-- Needed By Date -->
             <div class="mt-4">
                 <label class="block text-sm font-medium text-slate-300 mb-2">Needed By (Optional)</label>
                 <input type="datetime-local" 
                        name="needed_by" 
                        x-model="neededBy"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500 transition-all"
                        :min="minDate">
             </div>
             
             <!-- Purpose -->
             <div class="mt-4">
                 <label class="block text-sm font-medium text-slate-300 mb-2">Purpose / Reason</label>
                 <textarea name="purpose" 
                           x-model="purpose"
                           class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500 transition-all" 
                           placeholder="Explain why you need this item..."
                           required></textarea>
             </div>
            </div>
            
            <!-- Submit -->
            <div class="flex items-center justify-between">
             <a href="{% url 'supplies' %}" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm rounded-lg font-medium transition-all duration-200 cursor-pointer bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10">
                 <i data-lucide="arrow-left" class="w-4 h-4"></i>
                 Cancel
             </a>
             
             <button type="submit" 
                     class="inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm rounded-lg font-medium transition-all duration-200 cursor-pointer bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white shadow-lg shadow-green-500/20 disabled:opacity-50 disabled:cursor-not-allowed"
                     :disabled="!canSubmit || submitting">
                 <template x-if="submitting">
                     <div class="w-4 h-4 border-2 border-white/20 border-t-white rounded-full animate-spin"></div>
                 </template>
                 <template x-if="!submitting">
                     <i data-lucide="send" class="w-5 h-5"></i>
                 </template>
                 <span x-text="submitting ? 'Submitting...' : 'Submit Request'"></span>
             </button>
            </div>
    </form>
</div>

<script>
function requestForm() {
    return {
        searchQuery: '',
        filterCategory: '',
        searchResults: [],
        selectedSupply: null,
        selectedInstance: null,
        availableInstances: [],
        quantity: 1,
        priority: 'normal',
        neededBy: '',
        purpose: '',
        loading: false,
        submitting: false,
        
        get minDate() {
            return new Date().toISOString().slice(0, 16);
        },
        
        get canSubmit() {
            return this.selectedSupply && this.purpose.length > 0;
        },
        
        init() {
            // Check for pre-selected supply/instance from URL or context
            const urlParams = new URLSearchParams(window.location.search);
            const supplyId = urlParams.get('supply');
            const instanceId = urlParams.get('instance');
            
            {% if preselected_instance %}
            // Handle preselected instance from server context
            this.selectedSupply = {
                id: {{ preselected_instance.supply.id }},
                name: "{{ preselected_instance.supply.name }}",
                category: "{{ preselected_instance.supply.category.name }}",
                available: {{ preselected_instance.supply.available_quantity }},
                unit: "{{ preselected_instance.supply.unit }}",
                is_consumable: false
            };
            this.selectedInstance = {
                id: {{ preselected_instance.id }},
                code: "{{ preselected_instance.instance_code }}",
                serial: "{{ preselected_instance.serial_number|default:'' }}"
            };
            this.quantity = 1;
            
            // Load available instances
            this.loadAvailableInstances({{ preselected_instance.supply.id }});
            {% elif preselected_supply %}
            // Handle preselected supply from server context
            this.selectedSupply = {
                id: {{ preselected_supply.id }},
                name: "{{ preselected_supply.name }}",
                category: "{{ preselected_supply.category.name }}",
                available: {{ preselected_supply.available_quantity }},
                unit: "{{ preselected_supply.unit }}",
                is_consumable: {{ preselected_supply.is_consumable|yesno:"true,false" }}
            };
            this.quantity = 1;
            {% elif instanceId %}
            this.loadInstanceWithSupply(instanceId);
            {% elif supplyId %}
            this.loadSupply(supplyId);
            {% else %}
            this.searchSupplies();
            {% endif %}
        },
        
        async loadAvailableInstances(supplyId) {
            try {
                const response = await fetch(`/api/supplies/${supplyId}/instances/`);
                const data = await response.json();
                this.availableInstances = data.instances;
            } catch (error) {
                console.error('Failed to load instances:', error);
            }
        },
        
        async loadInstanceWithSupply(instanceId) {
            try {
                const response = await fetch(`{% url 'api_supplies_search' %}?q=`);
                const data = await response.json();
                const supply = data.results.find(s => !s.is_consumable);
                if (supply) {
                    this.selectSupply(supply);
                    this.$nextTick(() => {
                        this.selectedInstance = this.availableInstances.find(i => i.id == instanceId);
                    });
                }
            } catch (error) {
                console.error('Failed to load instance:', error);
            }
        },
        
        async searchSupplies() {
            this.loading = true;
            try {
                const params = new URLSearchParams({
                    q: this.searchQuery,
                    category: this.filterCategory
                });
                const response = await fetch(`{% url 'api_supplies_search' %}?${params}`);
                const data = await response.json();
                this.searchResults = data.results;
            } catch (error) {
                console.error('Search failed:', error);
            } finally {
                this.loading = false;
            }
        },
        
        async loadSupply(id) {
            try {
                const response = await fetch(`{% url 'api_supplies_search' %}?q=`);
                const data = await response.json();
                const supply = data.results.find(s => s.id == id);
                if (supply) {
                    this.selectSupply(supply);
                }
            } catch (error) {
                console.error('Failed to load supply:', error);
            }
        },
        
        async selectSupply(supply) {
            this.selectedSupply = supply;
            this.selectedInstance = null;
            this.quantity = 1;
            
            // Load available instances if equipment
            if (!supply.is_consumable) {
                try {
                    const response = await fetch(`/api/supplies/${supply.id}/instances/`);
                    const data = await response.json();
                    this.availableInstances = data.instances;
                } catch (error) {
                    console.error('Failed to load instances:', error);
                }
            }
        },
        
        async submitRequest() {
            if (!this.canSubmit) return;
            
            this.submitting = true;
            
            try {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                formData.append('supply_id', this.selectedSupply.id);
                formData.append('quantity', this.quantity);
                formData.append('priority', this.priority);
                formData.append('purpose', this.purpose);
                if (this.neededBy) formData.append('needed_by', this.neededBy);
                if (this.selectedInstance) formData.append('instance_id', this.selectedInstance.id);
                
                const response = await fetch('{% url "request_create" %}', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    const html = await response.text();
                    // Handle HTMX response or redirect
                    window.location.href = '{% url "my_requests" %}';
                }
            } catch (error) {
                console.error('Submit failed:', error);
                alert('Failed to submit request. Please try again.');
            } finally {
                this.submitting = false;
            }
        }
    }
}
</script>
{% endblock %}
