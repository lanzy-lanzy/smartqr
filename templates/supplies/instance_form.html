{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Smart Supply{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto fade-in">
    <!-- Back Button -->
    <a href="{% if instance %}{% url 'supply_detail' instance.supply.pk %}{% elif initial_supply %}{% url 'supply_detail' initial_supply.pk %}{% else %}{% url 'equipment' %}{% endif %}" up-follow class="inline-flex items-center gap-2 text-slate-400 hover:text-white transition-colors mb-6 group">
        <i data-lucide="arrow-left" class="w-5 h-5 group-hover:-translate-x-1 transition-transform"></i>
        <span>Back to Supply</span>
    </a>

    <div class="rounded-3xl border border-white/10 bg-gradient-to-br from-white/5 to-white/[0.02] backdrop-blur-xl overflow-hidden shadow-2xl">
        <div class="p-8 border-b border-white/10">
            <h2 class="heading-md flex items-center gap-3">
                <i data-lucide="{% if instance %}edit-3{% else %}plus-circle{% endif %}" class="w-6 h-6 text-primary-400"></i>
                {{ title }}
            </h2>
            <p class="text-slate-400 mt-2">
                {% if instance %}Updating instance {{ instance.instance_code }} for {{ instance.supply.name }}{% else %}Add a specific unit/instance to your equipment inventory.{% endif %}
            </p>
        </div>

        <form method="POST" class="p-8 space-y-6" 
              x-data="{ 
                mode: 'single', 
                instanceCode: '{{ instance.instance_code|default:'' }}',
                prefix: '',
                serials: '',
                isSuggesting: false,
                isSuggestingSerials: false,
                supply_name: '{% if instance %}{{ instance.supply.name }}{% elif initial_supply %}{{ initial_supply.name }}{% endif %}',
                async suggestPrefix() {
                    const supplySelect = document.getElementById('supply');
                    const targetName = this.supply_name || (supplySelect ? supplySelect.options[supplySelect.selectedIndex].text : '');
                    
                    if (!targetName || targetName === 'Select Equipment') {
                        alert('Please select a target supply first.');
                        return;
                    }
                    this.isSuggesting = true;
                    try {
                        const response = await fetch(`/api/v1/ai/suggest-prefix/?name=${encodeURIComponent(targetName)}`);
                        const result = await response.json();
                        if (result.data) {
                            if (this.mode === 'single') {
                                this.instanceCode = result.data.prefix + '-001';
                            } else {
                                this.prefix = result.data.prefix + '-';
                            }
                        } else if (result.error) {
                            alert('AI Error: ' + result.error);
                        }
                    } catch (e) {
                        alert('Error connecting to AI service.');
                    } finally {
                        this.isSuggesting = false;
                    }
                },
                async suggestSerials() {
                    const supplySelect = document.getElementById('supply');
                    const targetName = this.supply_name || (supplySelect ? supplySelect.options[supplySelect.selectedIndex].text : '');
                    
                    if (!targetName || targetName === 'Select Equipment') {
                        alert('Please select a target supply first.');
                        return;
                    }
                    this.isSuggestingSerials = true;
                    try {
                        const response = await fetch(`/api/v1/ai/suggest-serials/?name=${encodeURIComponent(targetName)}&count=10`);
                        const result = await response.json();
                        if (result.data && result.data.serials) {
                            this.serials = result.data.serials.join('\n');
                        } else if (result.error) {
                            alert('AI Error: ' + result.error);
                        }
                    } catch (e) {
                        alert('Error connecting to AI service.');
                    } finally {
                        this.isSuggestingSerials = false;
                    }
                }
              }">
            {% csrf_token %}
            
            <!-- Mode Toggle -->
            <div class="flex items-center gap-4 mb-6">
                <button type="button" @click="mode = 'single'" 
                        :class="mode === 'single' ? 'bg-primary-500/20 border-primary-500 text-white' : 'bg-white/5 border-white/10 text-slate-400'"
                        class="px-4 py-2 rounded-xl border transition-all text-sm font-semibold">
                    Single Instance
                </button>
                <button type="button" @click="mode = 'batch'" 
                        :class="mode === 'batch' ? 'bg-primary-500/20 border-primary-500 text-white' : 'bg-white/5 border-white/10 text-slate-400'"
                        class="px-4 py-2 rounded-xl border transition-all text-sm font-semibold">
                    Batch Mode
                </button>
            </div>

            <!-- Supply (Static or Select) -->
            <div class="space-y-2">
                <label for="supply" class="block text-sm font-semibold text-slate-300">Target Supply</label>
                {% if instance %}
                <div class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-slate-400 flex items-center gap-3">
                    <i data-lucide="package" class="w-5 h-5"></i>
                    {{ instance.supply.name }}
                    <input type="hidden" name="supply" value="{{ instance.supply.id }}">
                </div>
                {% elif initial_supply %}
                <div class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-slate-400 flex items-center gap-3">
                    <i data-lucide="package" class="w-5 h-5"></i>
                    {{ initial_supply.name }}
                    <input type="hidden" name="supply" value="{{ initial_supply.id }}">
                </div>
                {% else %}
                <select name="supply" id="supply" required
                        class="select w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:border-primary-500/50 text-white transition-all focus:outline-none focus:ring-2 focus:ring-primary-500/20">
                    <option value="">Select Equipment</option>
                    {% for s in supplies %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                    {% endfor %}
                </select>
                {% endif %}
            </div>

            <!-- Single Mode Fields -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" x-show="mode === 'single'">
                <div class="space-y-2">
                    <label for="instance_code" class="block text-sm font-semibold text-slate-300">Instance Code / Prop. No.</label>
                    <div class="flex gap-2">
                        <input type="text" name="instance_code" id="instance_code" :required="mode === 'single'" x-model="instanceCode"
                               class="flex-1 px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:border-primary-500/50 text-white transition-all focus:outline-none focus:ring-2 focus:ring-primary-500/20"
                               placeholder="e.g., LPT-001">
                        <button type="button" @click="suggestPrefix()" :disabled="isSuggesting" title="AI Suggest"
                                class="px-3 rounded-xl bg-primary-500/10 border border-primary-500/30 text-primary-400 hover:bg-primary-500/20 transition-all disabled:opacity-50">
                            <i data-lucide="sparkles" class="w-4 h-4" :class="isSuggesting ? 'animate-pulse' : ''"></i>
                        </button>
                    </div>
                </div>
                <div class="space-y-2">
                    <label for="serial_number" class="block text-sm font-semibold text-slate-300">Serial Number</label>
                    <input type="text" name="serial_number" id="serial_number" value="{{ instance.serial_number }}"
                           class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:border-primary-500/50 text-white transition-all focus:outline-none focus:ring-2 focus:ring-primary-500/20"
                           placeholder="SN: XXXXXX">
                </div>
            </div>

            <!-- Batch Mode Fields -->
            <div class="space-y-6" x-show="mode === 'batch'" x-cloak>
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-slate-300">Instance Code Prefix (Optional)</label>
                    <div class="flex gap-2">
                        <input type="text" name="code_prefix" x-model="prefix"
                               class="flex-1 px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:border-primary-500/50 text-white transition-all focus:outline-none focus:ring-2 focus:ring-primary-500/20"
                               placeholder="e.g., LPT-">
                        <button type="button" @click="suggestPrefix()" :disabled="isSuggesting"
                                class="px-4 py-3 rounded-xl bg-primary-500/10 border border-primary-500/30 text-primary-400 hover:bg-primary-500/20 transition-all flex items-center gap-2 whitespace-nowrap disabled:opacity-50">
                            <i data-lucide="sparkles" class="w-4 h-4" :class="isSuggesting ? 'animate-pulse' : ''"></i>
                            <span x-text="isSuggesting ? 'Thinking...' : 'AI Suggest'"></span>
                        </button>
                    </div>
                    <p class="text-xs text-slate-500">Auto-numbered codes will be generated: {PREFIX}001, {PREFIX}002, etc.</p>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <label class="block text-sm font-semibold text-slate-300">Serial Numbers (One per line)</label>
                        <button type="button" @click="suggestSerials()" :disabled="isSuggestingSerials"
                                class="text-[10px] flex items-center gap-1.5 px-2 py-1 rounded bg-secondary-500/10 border border-secondary-500/30 text-secondary-400 hover:bg-secondary-500/20 transition-all disabled:opacity-50">
                            <i data-lucide="sparkles" class="w-3 h-3" :class="isSuggestingSerials ? 'animate-pulse' : ''"></i>
                            <span x-text="isSuggestingSerials ? 'Generating...' : 'Suggest Serial Test'"></span>
                        </button>
                    </div>
                    <textarea name="batch_serials" :required="mode === 'batch'" rows="5" x-model="serials"
                              class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:border-primary-500/50 text-white transition-all focus:outline-none focus:ring-2 focus:ring-primary-500/20"
                              placeholder="SN123&#10;SN124&#10;SN125"></textarea>
                </div>
            </div>

            <!-- Common Status -->
            <div class="space-y-2">
                <label for="status" class="block text-sm font-semibold text-slate-300">Initial Status</label>
                <select name="status" id="status" required
                        class="select w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 focus:border-primary-500/50 text-white transition-all focus:outline-none focus:ring-2 focus:ring-primary-500/20">
                    {% for val, label in status_choices %}
                    <option value="{{ val }}" {% if instance.status == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="mode" :value="mode">
            </div>

            <!-- Submit Buttons -->
            <div class="flex items-center justify-end gap-4 pt-6 border-t border-white/10">
                <a href="{% if instance %}{% url 'supply_detail' instance.supply.pk %}{% elif initial_supply %}{% url 'supply_detail' initial_supply.pk %}{% else %}{% url 'equipment' %}{% endif %}" up-follow
                   class="px-6 py-3 rounded-xl bg-white/5 border border-white/10 text-slate-300 font-semibold hover:bg-white/10 transition-all">
                    Cancel
                </a>
                <button type="submit"
                        class="px-8 py-3 rounded-xl bg-gradient-to-r from-primary-600 to-primary-500 hover:from-primary-500 hover:to-primary-400 text-white font-bold transition-all shadow-lg hover:shadow-primary-500/30">
                    {% if instance %}Save Changes{% else %}Add Instance{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
