{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Smart Supply{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto fade-in">
    <!-- Back Button -->
    <a href="{% url 'categories' %}" up-follow class="inline-flex items-center gap-2 text-slate-500 hover:text-slate-300 transition-colors mb-6">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        <span class="text-sm">Back to Categories</span>
    </a>

    <div class="rounded-lg border border-slate-800 bg-slate-950/50 overflow-hidden">
        <div class="p-6 border-b border-slate-800">
            <h2 class="text-2xl font-semibold text-white">{{ title }}</h2>
            <p class="text-slate-500 text-sm mt-1">Organize and manage your inventory</p>
        </div>

        <form method="POST" class="p-6 space-y-5"
              x-data="{ 
                name: '{{ category.name|default:'' }}',
                selectedIcon: '{{ category.icon|default:'package' }}',
                isMaterial: {% if category.is_material %}true{% else %}false{% endif %},
                description: `{{ category.description|default:'' }}`,
                isSuggesting: false,
                async suggestCategory() {
                    if (!this.name) {
                        alert('Please enter a category name first.');
                        return;
                    }
                    this.isSuggesting = true;
                    try {
                        const response = await fetch(`/api/v1/ai/suggest-category/?name=${encodeURIComponent(this.name)}`);
                        const result = await response.json();
                        if (result.data) {
                            this.selectedIcon = result.data.icon;
                            this.isMaterial = result.data.is_material;
                            this.description = result.data.description;
                            // Refresh Lucide icons if any were added dynamically
                            setTimeout(() => { if(window.lucide) lucide.createIcons(); }, 100);
                        } else if (result.error) {
                            alert('AI Error: ' + result.error);
                        }
                    } catch (e) {
                        alert('Error connecting to AI service.');
                    } finally {
                        this.isSuggesting = false;
                    }
                }
              }">
            {% csrf_token %}
            
            <!-- Name -->
            <div>
                <label for="name" class="block text-sm font-medium text-white mb-2">Category Name</label>
                <div class="flex gap-2">
                    <input type="text" name="name" id="name" required x-model="name"
                           class="flex-1 px-4 py-2.5 rounded-lg bg-slate-900/50 border border-slate-800 text-white placeholder-slate-600 transition-all focus:outline-none focus:border-slate-700"
                           placeholder="e.g., IT Equipment, Office Supplies">
                    <button type="button" @click="suggestCategory()" :disabled="isSuggesting"
                            class="px-4 py-2.5 rounded-lg bg-slate-900/50 border border-slate-800 text-slate-300 hover:border-slate-700 transition-all flex items-center gap-2 whitespace-nowrap disabled:opacity-50">
                        <i data-lucide="sparkles" class="w-4 h-4" :class="isSuggesting ? 'animate-pulse' : ''"></i>
                        <span class="text-sm" x-text="isSuggesting ? 'Suggesting...' : 'Suggest'"></span>
                    </button>
                </div>
            </div>

            <!-- Icon -->
            <div>
                <label for="icon" class="block text-sm font-medium text-white mb-2">Icon</label>
                <div class="flex gap-3">
                    <input type="text" name="icon" id="icon" required x-model="selectedIcon"
                           class="flex-1 px-4 py-2.5 rounded-lg bg-slate-900/50 border border-slate-800 text-white placeholder-slate-600 transition-all focus:outline-none focus:border-slate-700"
                           placeholder="e.g., laptop, printer, package">
                    <div class="w-12 h-12 rounded-lg bg-slate-900 border border-slate-800 flex items-center justify-center flex-shrink-0">
                        <template x-if="selectedIcon">
                            <i :key="selectedIcon" :data-lucide="selectedIcon" class="w-5 h-5 text-slate-400"></i>
                        </template>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mt-1">Common: laptop, printer, package, hard-drive, cpu, keyboard, monitor, sofa</p>
            </div>

            <!-- Type -->
            <div>
                <label class="block text-sm font-medium text-white mb-2">Type</label>
                <div class="flex gap-3">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="is_material" value="off" :checked="!isMaterial" @change="isMaterial = false" class="hidden">
                        <div class="px-4 py-2.5 rounded-lg border text-center text-sm font-medium transition-all" :class="!isMaterial ? 'bg-slate-800 border-slate-700 text-white' : 'bg-slate-900/50 border-slate-800 text-slate-400'">
                            Consumable
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="is_material" value="on" :checked="isMaterial" @change="isMaterial = true" class="hidden">
                        <div class="px-4 py-2.5 rounded-lg border text-center text-sm font-medium transition-all" :class="isMaterial ? 'bg-slate-800 border-slate-700 text-white' : 'bg-slate-900/50 border-slate-800 text-slate-400'">
                            Equipment
                        </div>
                    </label>
                </div>
                <p class="text-xs text-slate-500 mt-1">Equipment must be returned; consumables are given out.</p>
            </div>

            <!-- Description -->
            <div>
                <label for="description" class="block text-sm font-medium text-white mb-2">Description</label>
                <textarea name="description" id="description" rows="3" x-model="description"
                          class="w-full px-4 py-2.5 rounded-lg bg-slate-900/50 border border-slate-800 text-white placeholder-slate-600 transition-all focus:outline-none focus:border-slate-700"
                          placeholder="Brief description of this category..."></textarea>
            </div>

            <!-- Submit Buttons -->
            <div class="flex items-center justify-end gap-3 pt-6 border-t border-slate-800">
                <a href="{% url 'categories' %}" up-follow
                   class="px-5 py-2.5 rounded-lg border border-slate-800 text-slate-300 text-sm font-medium hover:border-slate-700 hover:bg-slate-900/50 transition-all">
                    Cancel
                </a>
                <button type="submit"
                        class="px-6 py-2.5 rounded-lg bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium transition-all">
                    {% if category %}Save Changes{% else %}Create Category{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
