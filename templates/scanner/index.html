{% extends 'base.html' %}
{% load static %}

{% block title %}QR Scanner - Smart Supply{% endblock %}
{% block page_title %}QR Scanner{% endblock %}

{% block extra_head %}
<!-- QR Scanner Library is now in base.html -->
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto animate-fadeIn" x-data="qrScanner()" x-init="onInit()" @up:fragment:destroyed.window="onCleanup()">
    <!-- Header -->
    <div class="text-center mb-10">
        <h2 class="heading-lg">QR Code Scanner</h2>
        <p class="text-slate-400 mt-2">Scan equipment, request, or supply QR codes</p>
    </div>
    
    <!-- Scanner Mode Tabs -->
    <div class="flex justify-center gap-3 mb-8">
        <button @click="mode = 'scan'"
                :class="mode === 'scan' ? 'bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white shadow-lg shadow-green-500/20' : 'bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10'"
                class="inline-flex items-center justify-center gap-2 px-5 py-2.5 text-sm rounded-xl font-medium transition-all duration-200 cursor-pointer hover:-translate-y-0.5">
            <i data-lucide="scan" class="w-5 h-5"></i>
            <span class="hidden sm:inline">Scan</span>
        </button>
        <button @click="mode = 'issue'"
                :class="mode === 'issue' ? 'bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white shadow-lg shadow-green-500/20' : 'bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10'"
                class="inline-flex items-center justify-center gap-2 px-5 py-2.5 text-sm rounded-xl font-medium transition-all duration-200 cursor-pointer hover:-translate-y-0.5">
            <i data-lucide="arrow-up-right" class="w-5 h-5"></i>
            <span class="hidden sm:inline">Issue</span>
        </button>
        <button @click="mode = 'return'"
                :class="mode === 'return' ? 'bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white shadow-lg shadow-green-500/20' : 'bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10'"
                class="inline-flex items-center justify-center gap-2 px-5 py-2.5 text-sm rounded-xl font-medium transition-all duration-200 cursor-pointer hover:-translate-y-0.5">
            <i data-lucide="arrow-down-left" class="w-5 h-5"></i>
            <span class="hidden sm:inline">Return</span>
        </button>
    </div>
    
    <!-- Scanner Container -->
    <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl overflow-hidden shadow-2xl mb-8 hover:shadow-green-500/10 transition-shadow duration-300">
        <div class="p-6 border-b border-white/10 flex items-center justify-between">
            <h3 class="heading-sm flex items-center gap-3">
                <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                <span x-show="mode === 'scan'">General Scan</span>
                <span x-show="mode === 'issue'">Issue Item</span>
                <span x-show="mode === 'return'">Process Return</span>
            </h3>
            
            <div class="flex items-center gap-2">
                <button @click="toggleCamera"
                        :class="cameraActive ? 'bg-red-600 hover:bg-red-500' : 'bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400'"
                        class="px-4 py-2.5 rounded-xl font-medium text-white transition-all duration-200 inline-flex items-center gap-2 shadow-lg shadow-green-500/20 hover:-translate-y-0.5">
                    <i :data-lucide="cameraActive ? 'camera-off' : 'camera'" class="w-5 h-5"></i>
                    <span x-text="cameraActive ? 'Stop' : 'Start'" class="text-sm"></span>
                </button>
            </div>
        </div>
        
        <!-- Camera View -->
        <div class="relative rounded-none overflow-hidden bg-black aspect-video">
            <div id="qr-reader" class="w-full h-full"></div>
            
            <!-- Overlay when camera is off -->
            <div x-show="!cameraActive" 
                 class="absolute inset-0 flex flex-col items-center justify-center bg-gradient-to-b from-slate-900 to-black">
                 <i data-lucide="camera" class="w-20 h-20 text-slate-600 mb-6 opacity-50"></i>
                <p class="text-slate-400 text-center">Click "Start" to activate camera</p>
            </div>
            
            <!-- Scanning Frame Overlay -->
            <div x-show="cameraActive" class="absolute inset-0 pointer-events-none flex items-center justify-center">
                <div class="w-40 h-40 sm:w-48 sm:h-48 border-2 border-green-500 rounded-3xl relative shadow-2xl shadow-green-500/50">
                    <div class="absolute -top-3 -left-3 w-8 h-8 border-t-4 border-l-4 border-green-400 rounded-tl-2xl"></div>
                    <div class="absolute -top-3 -right-3 w-8 h-8 border-t-4 border-r-4 border-green-400 rounded-tr-2xl"></div>
                    <div class="absolute -bottom-3 -left-3 w-8 h-8 border-b-4 border-l-4 border-green-400 rounded-bl-2xl"></div>
                    <div class="absolute -bottom-3 -right-3 w-8 h-8 border-b-4 border-r-4 border-green-400 rounded-br-2xl"></div>
                </div>
            </div>
        </div>
        
        <!-- Manual Entry -->
        <div class="p-6 border-t border-white/10 space-y-3">
            <label class="block text-sm font-medium text-slate-300">Or enter QR code manually</label>
            <div class="flex gap-3">
                <input type="text" 
                       x-model="manualCode"
                       @keyup.enter="processManualCode"
                       class="flex-1 px-4 py-2.5 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:border-green-500 transition-all"
                       placeholder="e.g., INSTANCE-123 or BORROW-456-789-012">
                <button @click="processManualCode" 
                        :disabled="!manualCode"
                        class="px-5 py-2.5 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 disabled:bg-slate-700 disabled:cursor-not-allowed rounded-xl font-medium text-white transition-all duration-200 shadow-lg shadow-green-500/20 hover:-translate-y-0.5">
                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Scan Result -->
    <template x-if="scanResult">
        <div class="bg-white/5 backdrop-blur-xl border-2 rounded-2xl overflow-hidden shadow-2xl mb-8"
             :class="scanResult.success ? 'border-green-500/50 shadow-green-500/10' : 'border-red-500/50 shadow-red-500/10'">
            <div class="p-6 flex items-start gap-4">
                <div class="w-14 h-14 rounded-xl flex items-center justify-center flex-shrink-0"
                     :class="scanResult.success ? 'bg-green-500/20' : 'bg-red-500/20'">
                    <i :data-lucide="scanResult.success ? 'check-circle' : 'x-circle'" 
                       class="w-7 h-7"
                       :class="scanResult.success ? 'text-green-400' : 'text-red-400'"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-semibold text-lg mb-3" :class="scanResult.success ? 'text-green-300' : 'text-red-300'" x-text="scanResult.success ? 'Scan Successful' : 'Scan Failed'"></h4>
                    
                    <template x-if="scanResult.success">
                        <div>
                            <!-- Instance Result -->
                            <template x-if="scanResult.type === 'instance'">
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-lg font-bold text-white" x-text="scanResult.data.code"></p>
                                            <p class="text-slate-400" x-text="scanResult.data.supply"></p>
                                        </div>
                                        <div class="text-right">
                                            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium border capitalize"
                                                  :class="{
                                                      'bg-green-500/20 text-green-300 border-green-500/30': scanResult.data.status === 'available',
                                                      'bg-blue-500/20 text-blue-300 border-blue-500/30': scanResult.data.status === 'borrowed',
                                                      'bg-red-500/20 text-red-300 border-red-500/30': scanResult.data.status === 'damaged' || scanResult.data.status === 'lost',
                                                      'bg-slate-500/20 text-slate-300 border-slate-500/30': true
                                                  }"
                                                  x-text="scanResult.data.status"></span>
                                        </div>
                                    </div>

                                    <div class="flex items-center gap-3 flex-wrap">
                                        <template x-if="scanResult.data.current_borrower">
                                            <span class="text-sm text-slate-400">
                                                ðŸ‘¤ <span x-text="scanResult.data.current_borrower"></span>
                                            </span>
                                        </template>
                                    </div>

                                    <!-- Pending Approvals for this Instance Type -->
                                    <template x-if="scanResult.data.status === 'available' && scanResult.data.pending_approvals && scanResult.data.pending_approvals.length > 0">
                                        <div class="mt-4 p-4 bg-green-500/5 border border-green-500/20 rounded-2xl">
                                            <p class="text-[10px] font-bold text-green-500 uppercase tracking-widest mb-3">Pending Approved Requests</p>
                                            <div class="space-y-2">
                                                <template x-for="req in scanResult.data.pending_approvals" :key="req.id">
                                                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5">
                                                        <div class="min-w-0 flex-1">
                                                            <p class="text-xs font-bold text-white truncate" x-text="req.requester"></p>
                                                            <p class="text-[9px] text-slate-500 font-mono" x-text="req.code"></p>
                                                        </div>
                                                        <button @click="issueData = req; selectedInstanceId = scanResult.data.id; showIssueModal = true; $nextTick(() => lucide.createIcons());" 
                                                                class="px-3 py-1.5 bg-green-600 hover:bg-green-500 text-white text-[10px] font-bold uppercase tracking-wider rounded-lg transition-all shadow-lg shadow-green-600/20">
                                                            Issue This Unit
                                                        </button>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            
                            <!-- Request Result -->
                            <template x-if="scanResult.type === 'request'">
                                <div class="space-y-3">
                                    <p class="text-lg font-bold text-white" x-text="scanResult.data.code"></p>
                                    <p class="text-slate-400">
                                        <span x-text="scanResult.data.supply"></span> <span class="text-slate-500">Ã—</span> <span x-text="scanResult.data.quantity"></span>
                                    </p>
                                    <p class="text-sm text-slate-400">ðŸ‘¤ <span x-text="scanResult.data.requester"></span></p>
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-500/20 text-blue-300 text-sm font-medium border border-blue-500/30" x-text="scanResult.data.status"></span>
                                </div>
                            </template>
                            
                            <!-- Supply Result -->
                            <template x-if="scanResult.type === 'supply'">
                                <div class="space-y-3">
                                    <p class="text-lg font-bold text-white" x-text="scanResult.data.name"></p>
                                    <p class="text-slate-400">
                                        ðŸ“¦ Available: <span x-text="scanResult.data.available"></span> / <span x-text="scanResult.data.quantity"></span>
                                    </p>
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-500/20 text-blue-300 text-sm font-medium border border-blue-500/30" x-text="scanResult.data.status"></span>
                                </div>
                            </template>

                            <!-- Batch Result -->
                            <template x-if="scanResult.type === 'batch'">
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Batch Group</p>
                                        <p class="text-xs font-mono text-slate-400 truncate max-w-[150px]" x-text="scanResult.data.batch_id"></p>
                                    </div>
                                    <div class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar pr-1">
                                        <template x-for="req in scanResult.data.requests" :key="req.id">
                                            <div :id="'batch-item-' + req.id" class="p-4 bg-white/5 border border-white/10 rounded-2xl flex flex-col gap-3 group hover:bg-white/[0.07] transition-all">
                                                <div class="min-w-0 flex-1">
                                                    <div class="flex items-center justify-between mb-1">
                                                        <p class="text-sm font-bold text-white truncate" x-text="req.supply"></p>
                                                        <span :class="{
                                                            'bg-blue-500/10 text-blue-400 border-blue-500/20': req.status === 'issued',
                                                            'bg-green-500/10 text-green-400 border-green-500/20': req.status === 'returned' || req.status === 'approved',
                                                            'bg-slate-500/10 text-slate-500 border-slate-500/20': req.status === 'pending'
                                                        }" class="text-[9px] font-bold px-2 py-0.5 rounded border uppercase tracking-tighter" x-text="req.status"></span>
                                                    </div>
                                                    <p class="text-[10px] text-slate-500 font-mono tracking-wider" x-text="req.code"></p>
                                                </div>

                                                <div class="flex items-center gap-2 mt-1">
                                                    <template x-if="req.status === 'issued' && req.instance_id">
                                                        <div class="flex items-center gap-2 w-full">
                                                            <button @click="quickReturn(req, 'good')" 
                                                                    type="button"
                                                                    class="flex-1 py-1.5 rounded-xl bg-green-500/10 text-green-500 text-[10px] font-bold uppercase tracking-widest hover:bg-green-500 hover:text-slate-950 transition-all border border-green-500/20">
                                                                Good
                                                            </button>
                                                            <button @click="quickReturn(req, 'damaged')" 
                                                                    type="button"
                                                                    class="flex-1 py-1.5 rounded-xl bg-amber-500/10 text-amber-500 text-[10px] font-bold uppercase tracking-widest hover:bg-amber-500 hover:text-slate-950 transition-all border border-amber-500/20">
                                                                Damage
                                                            </button>
                                                            <button @click="quickReturn(req, 'lost')" 
                                                                    type="button"
                                                                    class="flex-1 py-1.5 rounded-xl bg-red-500/10 text-red-500 text-[10px] font-bold uppercase tracking-widest hover:bg-red-500 hover:text-slate-950 transition-all border border-red-500/20">
                                                                Lost
                                                            </button>
                                                        </div>
                                                    </template>
                                                    <template x-if="req.status === 'approved'">
                                                        <button @click="issueData = req; selectedInstanceId = null; showIssueModal = true; $nextTick(() => lucide.createIcons());" 
                                                                type="button"
                                                                class="w-full py-2 rounded-xl bg-green-600 text-white text-xs font-bold uppercase tracking-widest hover:bg-green-500 transition-all flex items-center justify-center gap-2">
                                                            <i data-lucide="package-check" class="w-4 h-4"></i>
                                                            Issue Unit
                                                        </button>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                    
                    <template x-if="!scanResult.success">
                        <p class="text-red-300" x-text="scanResult.message"></p>
                    </template>
                </div>
                
                <button @click="scanResult = null" class="p-2 hover:bg-white/10 rounded-xl transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-slate-400"></i>
                </button>
            </div>
            
            <!-- Action Buttons -->
            <template x-if="scanResult.success">
                <div class="p-6 pt-4 border-t border-white/10 flex flex-wrap gap-3">
                    <template x-if="scanResult.type === 'instance' && (mode === 'return' || true) && scanResult.data.status === 'borrowed'">
                        <button @click="processReturn(scanResult.data.id, scanResult.data.code, scanResult.data.supply)" class="px-4 py-2.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 rounded-xl font-medium text-white transition-all duration-200 inline-flex items-center gap-2 shadow-lg shadow-blue-500/20 hover:-translate-y-0.5">
                            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                            Process Return
                        </button>
                    </template>
                    
                    <template x-if="scanResult.type === 'request' && scanResult.data.status === 'issued' && scanResult.data.instance_id">
                        <button @click="processReturn(scanResult.data.instance_id, scanResult.data.instance_code, scanResult.data.supply)" class="px-4 py-2.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 rounded-xl font-medium text-white transition-all duration-200 inline-flex items-center gap-2 shadow-lg shadow-blue-500/20 hover:-translate-y-0.5">
                            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                            Process Return
                        </button>
                    </template>
                    
                    <template x-if="scanResult.type === 'request' && scanResult.data.status === 'approved'">
                        <button @click="showIssueModal = true" class="px-4 py-2.5 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 rounded-xl font-medium text-white transition-all duration-200 inline-flex items-center gap-2 shadow-lg shadow-green-500/20 hover:-translate-y-0.5">
                            <i data-lucide="package-check" class="w-5 h-5"></i>
                            Issue Items
                        </button>
                    </template>
                    
                    <button @click="scanResult = null" class="px-4 py-2.5 bg-white/5 border border-white/10 hover:bg-white/10 rounded-xl font-medium text-slate-300 transition-all duration-200">
                        Scan Another
                    </button>
                </div>
            </template>
        </div>
    </template>
    
    <!-- Recent Scans -->
    <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-2xl">
        <h3 class="heading-sm mb-6 flex items-center gap-2">
            <i data-lucide="history" class="w-5 h-5 text-slate-400"></i>
            Recent Scans
        </h3>
        <div class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar">
            <template x-for="scan in recentScans" :key="scan.id">
                <div class="flex items-center gap-3 p-3 bg-white/5 hover:bg-white/10 rounded-xl transition-colors">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"
                         :class="scan.success ? 'bg-green-500/20' : 'bg-red-500/20'">
                        <i :data-lucide="scan.success ? 'check-circle' : 'x-circle'" 
                           class="w-5 h-5"
                           :class="scan.success ? 'text-green-400' : 'text-red-400'"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-mono text-sm text-white truncate" x-text="scan.code"></p>
                        <p class="text-xs text-slate-500" x-text="scan.time"></p>
                    </div>
                    <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-slate-500/20 text-slate-300 text-xs font-medium border border-slate-500/30 capitalize" x-text="scan.type"></span>
                </div>
            </template>
            
            <template x-if="recentScans.length === 0">
                <div class="text-center py-8">
                    <i data-lucide="inbox" class="w-12 h-12 text-slate-600 mx-auto mb-2 opacity-50"></i>
                    <p class="text-slate-500">No scans yet</p>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Issue Modal -->
    <template x-if="showIssueModal">
        <div class="fixed inset-0 bg-slate-950/40 backdrop-blur-xl z-[100] flex items-center justify-center p-4"
             @click.self="showIssueModal = false"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-cloak>
            <div @click.stop
                 class="bg-slate-900/90 border border-white/10 rounded-2xl shadow-2xl max-w-md w-full overflow-hidden animate-fadeIn"
                 x-transition:enter="transition ease-out duration-300 transform scale-95"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100">
                
                <!-- Modal Header -->
                <div class="px-8 py-6 border-b border-white/10 flex justify-between items-center bg-gradient-to-r from-green-500/10 to-transparent">
                    <div>
                        <h3 class="text-xl font-bold text-white">Issue Equipment</h3>
                        <p class="text-xs text-slate-500 mt-0.5 uppercase tracking-widest font-bold">Fulfillment Pipeline</p>
                    </div>
                    <button @click="showIssueModal = false" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/10 text-slate-400 hover:text-white transition-all">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="p-8 space-y-6">
                    <!-- Request Info -->
                    <div class="p-4 bg-white/5 border border-white/10 rounded-2xl">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center text-green-400">
                                <i data-lucide="package-check" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Active Request</p>
                                <p class="font-bold text-white" x-text="issueData ? issueData.code : ''"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-slate-500 text-xs">Item</p>
                                <p class="text-white font-medium truncate" x-text="issueData ? issueData.supply : ''"></p>
                            </div>
                            <div>
                                <p class="text-slate-500 text-xs">Requester</p>
                                <p class="text-white font-medium truncate" x-text="issueData ? issueData.requester : ''"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Instance Selection -->
                    <template x-if="issueData && !issueData.is_consumable">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Select Specific Unit</label>
                            <div class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-2" x-init="fetchInstances()">
                                <template x-for="instance in availableInstances" :key="instance.id">
                                    <button @click="selectedInstanceId = instance.id"
                                            class="w-full flex items-center justify-between p-4 rounded-xl border transition-all duration-200"
                                            :class="selectedInstanceId === instance.id ? 'bg-green-500/10 border-green-500/50 text-white' : 'bg-white/5 border-white/5 text-slate-400 hover:bg-white/10 hover:border-white/10'">
                                        <div class="flex items-center gap-3">
                                            <i data-lucide="monitor" class="w-4 h-4"></i>
                                            <span class="font-mono text-sm" x-text="instance.code"></span>
                                        </div>
                                        <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all"
                                             :class="selectedInstanceId === instance.id ? 'border-green-500 bg-green-500' : 'border-white/10'">
                                            <i data-lucide="check" class="w-3 h-3 text-white" x-show="selectedInstanceId === instance.id"></i>
                                        </div>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template x-if="issueData && issueData.is_consumable">
                        <div class="p-4 bg-amber-500/10 border border-amber-500/20 rounded-2xl flex items-start gap-3">
                            <i data-lucide="info" class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"></i>
                            <div>
                                <p class="text-xs font-bold text-amber-500 uppercase tracking-widest mb-1">Stock Item</p>
                                <p class="text-[10px] text-slate-400">This is a consumable item. No specific unit selection is required. Issuing this will deduct from the available stock.</p>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div class="p-8 pt-0 flex gap-4">
                    <button type="button" @click="showIssueModal = false" class="flex-1 px-4 py-3.5 bg-white/5 border border-white/10 rounded-xl font-bold text-slate-500 hover:bg-white/10 transition-all">
                        Cancel
                    </button>
                    <button @click="submitIssue" 
                            :disabled="issueData && !issueData.is_consumable && !selectedInstanceId"
                            class="flex-2 px-8 py-3.5 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white rounded-xl font-bold transition-all duration-300 shadow-lg shadow-green-500/20 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed">
                        Finalize Issuance
                    </button>
                </div>
            </div>
        </div>
    </template>

    <!-- Return Modal -->
    <template x-if="showReturnModal">
        <div class="fixed inset-0 bg-slate-950/40 backdrop-blur-xl z-[100] flex items-center justify-center p-4"
             @click.self="showReturnModal = false"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-cloak>
            <div @click.stop
                 class="bg-slate-900/90 border border-white/10 rounded-2xl shadow-2xl max-w-md w-full overflow-hidden animate-fadeIn"
                 x-transition:enter="transition ease-out duration-300 transform scale-95"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100">
                
                <!-- Modal Header -->
                <div class="px-8 py-6 border-b border-white/10 flex justify-between items-center bg-gradient-to-r from-blue-500/10 to-transparent">
                    <div>
                        <h3 class="text-xl font-bold text-white">Process Return</h3>
                        <p class="text-xs text-slate-500 mt-0.5 uppercase tracking-widest font-bold">Return Pipeline</p>
                    </div>
                    <button @click="showReturnModal = false" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white/10 text-slate-400 hover:text-white transition-all">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="p-8 space-y-6">
                    <!-- Item Info -->
                    <div class="p-4 bg-white/5 border border-white/10 rounded-2xl">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center text-blue-400">
                                <i data-lucide="monitor" class="w-6 h-6"></i>
                            </div>
                            <template x-if="scanResult && scanResult.data">
                                <div>
                                    <p class="text-white font-bold" x-text="scanResult.data.code"></p>
                                    <p class="text-slate-500 text-xs" x-text="scanResult.data.supply"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Return Condition -->
                    <div class="space-y-3">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest">Return Condition</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button @click="returnStatus = 'good'"
                                    :class="returnStatus === 'good' ? 'bg-green-500/10 border-green-500/50 text-green-400 shadow-lg shadow-green-500/10' : 'bg-white/5 border-white/5 text-slate-400 hover:bg-white/10'"
                                    class="p-4 py-6 rounded-xl border flex flex-col items-center justify-center gap-2 transition-all">
                                <span class="text-xs font-bold uppercase tracking-wider">Good</span>
                            </button>
                            <button @click="returnStatus = 'damaged'"
                                    :class="returnStatus === 'damaged' ? 'bg-amber-500/10 border-amber-500/50 text-amber-400 shadow-lg shadow-amber-500/10' : 'bg-white/5 border-white/5 text-slate-400 hover:bg-white/10'"
                                    class="p-4 py-6 rounded-xl border flex flex-col items-center justify-center gap-2 transition-all">
                                <span class="text-xs font-bold uppercase tracking-wider">Damage</span>
                            </button>
                            <button @click="returnStatus = 'lost'"
                                    :class="returnStatus === 'lost' ? 'bg-red-500/10 border-red-500/50 text-red-400 shadow-lg shadow-red-500/10' : 'bg-white/5 border-white/5 text-slate-400 hover:bg-white/10'"
                                    class="p-4 py-6 rounded-xl border flex flex-col items-center justify-center gap-2 transition-all">
                                <span class="text-xs font-bold uppercase tracking-wider">Lost</span>
                            </button>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="space-y-3">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest">Optional Notes</label>
                        <textarea x-model="returnNotes" 
                                  class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all resize-none h-24"
                                  placeholder="Add any details about the item's condition..."></textarea>
                    </div>
                </div>
                
                <div class="p-8 pt-0 flex gap-4">
                    <button type="button" @click="showReturnModal = false" class="flex-1 px-4 py-3.5 bg-white/5 border border-white/10 rounded-xl font-bold text-slate-500 hover:bg-white/10 transition-all">
                        Cancel
                    </button>
                    <button @click="submitReturn" 
                            class="flex-2 px-8 py-3.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white rounded-xl font-bold transition-all duration-300 shadow-lg shadow-blue-500/20 hover:-translate-y-1">
                        Confirm Return
                    </button>
                </div>
            </div>
        </div>
    </template>
</div>

<script>
function qrScanner() {
    return {
        mode: 'scan',
        cameraActive: false,
        scanner: null,
        manualCode: '',
        scanResult: null,
        recentScans: [],
        showReturnModal: false,
        showIssueModal: false,
        returnStatus: 'good',
        returnNotes: '',
        currentInstanceId: null,
        issueData: null,
        availableInstances: [],
        selectedInstanceId: null,

        onInit() {
            console.log('Scanner initialized');
        },

        onCleanup() {
            console.log('Scanner cleanup');
            this.stopCamera();
        },
        
        toggleCamera() {
            if (this.cameraActive) {
                this.stopCamera();
            } else {
                this.startCamera();
            }
        },
        
        startCamera() {
            this.scanner = new Html5Qrcode("qr-reader");
            
            const config = {
                fps: 10,
                qrbox: (viewfinderWidth, viewfinderHeight) => {
                    const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                    const qrboxSize = Math.floor(minEdge * 0.7);
                    return { width: qrboxSize, height: qrboxSize };
                },
                aspectRatio: 1.0
            };
            
            this.scanner.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    this.onScanSuccess(decodedText);
                },
                (error) => {
                    // Ignore errors during scanning
                }
            ).then(() => {
                this.cameraActive = true;
                this.scanResult = null; // Clear previous results
            }).catch((err) => {
                console.error('Camera start failed:', err);
                // Fallback to any camera if environment fails
                this.scanner.start(
                    { facingMode: "user" },
                    config,
                    (decodedText) => this.onScanSuccess(decodedText)
                ).then(() => {
                    this.cameraActive = true;
                }).catch(e => {
                    alert('Failed to start camera. Please check permissions.');
                });
            });
        },
        
        stopCamera() {
            if (this.scanner) {
                this.scanner.stop().then(() => {
                    this.cameraActive = false;
                    this.scanner = null;
                }).catch(err => {
                    console.error('Stop failed:', err);
                    this.cameraActive = false;
                });
            }
        },
        
        async onScanSuccess(code) {
            // Pause scanning to prevent multiple hits
            if (this.scanner && this.cameraActive) {
                try {
                    this.scanner.pause();
                } catch (e) {}
            }
            
            await this.processCode(code);
            
            // Resume after delay
            setTimeout(() => {
                if (this.scanner && this.cameraActive) {
                    try {
                        this.scanner.resume();
                    } catch (e) {}
                }
            }, 3000);
        },
        
        async processManualCode() {
            if (!this.manualCode) return;
            await this.processCode(this.manualCode);
            this.manualCode = '';
        },
        quickReturn(req, status) {
            const formData = new FormData();
            formData.append('status', status);
            formData.append('notes', 'Batch return via scanner');
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch(`/returns/process/${req.instance_id}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Update the local scanResult data to reflect the return
                    const index = this.scanResult.data.requests.findIndex(r => r.id === req.id);
                    if (index !== -1) {
                        this.scanResult.data.requests[index].status = 'returned';
                    }
                    // Trigger icon refresh if needed
                    this.$nextTick(() => lucide.createIcons());
                } else {
                    alert(result.error || 'Failed to process return');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while processing the return');
            });
        },
        
        async processCode(code) {
            try {
                this.scanResult = null;
                const formData = new FormData();
                formData.append('qr_data', code);
                formData.append('scan_type', this.mode);
                
                const response = await fetch('{% url "process_qr_scan" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                });
                
                const result = await response.json();
                this.scanResult = result;
                
                // Process scan results automatically for certain types
                if (result.success) {
                    if (result.type === 'request') {
                        if (result.data.status === 'approved') {
                            this.issueData = result.data;
                            // Pre-select requested instance if any
                            this.selectedInstanceId = result.data.requested_instance_id || null;
                            this.showIssueModal = true;
                        }
                    } else if (result.type === 'instance' && this.mode === 'return') {
                        if (result.data.status === 'borrowed') {
                            this.processReturn(result.data.id, result.data.code, result.data.supply);
                        }
                    } else if (result.type === 'instance' && this.showIssueModal) {
                        // If issue modal is open, select the scanned instance if it matches the supply
                        if (result.data.status === 'available' && result.data.supply_id === this.issueData.supply_id) {
                            this.selectedInstanceId = result.data.id;
                        } else if (result.data.supply_id !== this.issueData.supply_id) {
                            alert(`Warning: Scanned unit ${result.data.code} belongs to ${result.data.supply}, not ${this.issueData.supply}.`);
                        }
                    } else if (result.type === 'instance' && this.mode === 'issue' && result.data.pending_approvals && result.data.pending_approvals.length === 1) {
                        // Auto-select if there's only one request and we are in issue mode
                        this.issueData = result.data.pending_approvals[0];
                        this.selectedInstanceId = result.data.id;
                        this.showIssueModal = true;
                        this.$nextTick(() => lucide.createIcons());
                    }
                }
                
                // Add to recent scans
                this.recentScans.unshift({
                    id: Date.now(),
                    code: code,
                    type: result.type || 'unknown',
                    success: result.success,
                    time: new Date().toLocaleTimeString()
                });
                
                if (this.recentScans.length > 10) this.recentScans.pop();
                
                // Re-init icons
                setTimeout(() => {
                    if (window.lucide) lucide.createIcons();
                }, 100);

            } catch (error) {
                console.error('Process failed:', error);
                this.scanResult = { success: false, message: 'Failed to process QR code' };
            }
        },
        
        async fetchInstances() {
            if (!this.issueData || !this.issueData.supply_id) return;
            try {
                const response = await fetch(`/api/supplies/${this.issueData.supply_id}/instances/`);
                const result = await response.json();
                this.availableInstances = result.instances;
                
                setTimeout(() => {
                    if (window.lucide) lucide.createIcons();
                }, 50);
            } catch (error) {
                console.error('Fetch instances failed:', error);
            }
        },

        processReturn(instanceId, code, name) {
            this.currentInstanceId = instanceId;
            this.returnStatus = 'good';
            this.returnNotes = '';
            this.showReturnModal = true;
        },
        
        async submitIssue() {
            try {
                const formData = new FormData();
                formData.append('request_id', this.issueData.id);
                if (this.selectedInstanceId) {
                    formData.append('instance_id', this.selectedInstanceId);
                }
                
                const response = await fetch('{% url "issue_item" %}', { 
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showIssueModal = false;
                    this.scanResult = null;
                    alert(result.message || 'Item issued successfully');
                } else {
                    alert(result.error || 'Failed to issue item');
                }
            } catch (error) {
                console.error('Issue failed:', error);
                alert('Failed to process issuance');
            }
        },
        
        async submitReturn() {
            try {
                const formData = new FormData();
                formData.append('instance_id', this.currentInstanceId);
                formData.append('return_status', this.returnStatus);
                formData.append('notes', this.returnNotes);
                
                const response = await fetch('{% url "process_return" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.showReturnModal = false;
                    this.scanResult = null;
                    this.returnStatus = 'good';
                    this.returnNotes = '';
                    alert(result.message || 'Return processed successfully');
                    window.location.href = "{% url 'returns' %}?filter=history";
                } else {
                    alert(result.error || 'Failed to process return');
                }
            } catch (error) {
                console.error('Return failed:', error);
                alert('Failed to process return');
            }
        }
    }
}
</script>
{% endblock %}
